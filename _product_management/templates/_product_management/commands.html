{% extends "base.html" %}
{% load static %}

{% block title %}Commands{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12 col-lg-8">
    <h1 class="mb-4">Product Management Commands</h1>

    <div class="card">
      <div class="card-body">
        <h5 class="card-title">Run Data Job</h5>
        <p class="text-muted">Kick off catalog data pipeline steps. Runs in the background.</p>
        <form method="post" class="vstack gap-3">
          {% csrf_token %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" id="all" name="all">
            <label class="form-check-label" for="all">Run all steps</label>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="scrape" name="scrape">
                <label class="form-check-label" for="scrape">Scrape products</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="no_scrape" name="no_scrape">
                <label class="form-check-label" for="no_scrape">Skip scrape</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="vat" name="vat">
                <label class="form-check-label" for="vat">Update VAT rates</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="variants" name="variants">
                <label class="form-check-label" for="variants">Backfill variants</label>
              </div>
              <div class="input-group input-group-sm mt-1">
                <span class="input-group-text">Variants limit</span>
                <input type="number" min="0" step="1" class="form-control" name="variants_limit" placeholder="0 = no limit">
              </div>
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" value="1" id="variants_dry_run" name="variants_dry_run">
                <label class="form-check-label" for="variants_dry_run">Variants dry-run</label>
              </div>
              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" value="1" id="home_subcats" name="home_subcats">
                <label class="form-check-label" for="home_subcats">Populate home subcategories</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" value="1" id="home_inactive" name="home_inactive">
                <label class="form-check-label" for="home_inactive">Create home subcategories as inactive</label>
              </div>
            </div>
          </div>

          <div class="col-md-3 mt-2">
            <label for="verbosity" class="form-label">Verbosity</label>
            <select id="verbosity" name="verbosity" class="form-select form-select-sm">
              <option value="0">0 - errors</option>
              <option value="1" selected>1 - normal</option>
              <option value="2">2 - verbose</option>
              <option value="3">3 - very verbose</option>
            </select>
          </div>

          <div class="mt-3">
            <button type="submit" class="btn btn-success">Run Data Job</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Scrape Retail EAN</h5>
        <p class="text-muted">Fetch product pages and populate missing Retail EANs. Runs in the background.</p>
        <form method="post" class="vstack gap-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="scrape_retail_ean">

          <div class="row g-3">
            <div class="col-md-4">
              <label for="ean_limit" class="form-label">Limit</label>
              <input id="ean_limit" type="number" min="0" step="1" name="limit" class="form-control" placeholder="0 = no limit">
            </div>
            <div class="col-md-4">
              <label for="ean_sleep" class="form-label">Sleep (seconds)</label>
              <input id="ean_sleep" type="number" min="0" step="0.1" name="sleep" class="form-control" value="0.5">
            </div>
            <div class="col-md-4">
              <label for="ean_domain" class="form-label">Only domain contains</label>
              <input id="ean_domain" type="text" name="only_domain" class="form-control" placeholder="e.g. bestwaywholesale.co.uk">
            </div>
          </div>

          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="ean_force" name="force">
                <label class="form-check-label" for="ean_force">Force overwrite existing EAN</label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="ean_dry" name="dry_run">
                <label class="form-check-label" for="ean_dry">Dry-run (no save)</label>
              </div>
            </div>
            <div class="col-md-4">
              <label for="ean_verbosity" class="form-label">Verbosity</label>
              <select id="ean_verbosity" name="verbosity" class="form-select form-select-sm">
                <option value="0">0 - errors</option>
                <option value="1" selected>1 - normal</option>
                <option value="2">2 - verbose</option>
                <option value="3">3 - very verbose</option>
              </select>
            </div>
          </div>

          <div class="mt-3">
            <button type="submit" class="btn btn-primary">Start EAN Scrape</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card mt-4 border-danger">
      <div class="card-body">
        <h5 class="card-title text-danger">Danger Zone: Clear All Products</h5>
        <p class="text-muted">Deletes every row in All_Products. This cannot be undone.</p>
        <form method="post" class="vstack gap-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="clear_all_products">
          <div class="alert alert-warning">
            <div>
              Current product count: <strong>{{ product_count }}</strong>
            </div>
            <ul class="mb-0 mt-2">
              <li>Step 1: Tick the acknowledgement checkbox.</li>
              <li>Step 2: Type <code>DELETE ALL PRODUCTS</code> below.</li>
              <li>Step 3: Enter the current product count exactly.</li>
            </ul>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" value="1" id="ack" name="ack">
            <label class="form-check-label" for="ack">I understand this action will permanently delete all products.</label>
          </div>
          <div class="row g-3">
            <div class="col-md-6">
              <label for="confirm_phrase" class="form-label">Confirmation phrase</label>
              <input id="confirm_phrase" name="confirm_phrase" type="text" class="form-control" placeholder="DELETE ALL PRODUCTS">
            </div>
            <div class="col-md-6">
              <label for="confirm_count" class="form-label">Confirm product count</label>
              <input id="confirm_count" name="confirm_count" type="number" min="0" class="form-control" placeholder="{{ product_count }}">
            </div>
          </div>
          <div class="mt-3">
            <button type="submit" class="btn btn-outline-danger">Clear All Products</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
