{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DL Size Leaflet</title>
  <link rel="stylesheet" href="{% static 'css/leaflet.css' %}">
  {# All print/PDF styles live in static/css/leaflet.css now #}
  </head>
<body>
  <!-- Controls outside the printable leaflet -->
  {% if not pdf %}
  <div class="leaflet-toolbar">
    {% if leaflet_saved %}
    <div class="leaflet-alert">Default leaflet text saved.</div>
    {% endif %}
    <a href="{% url 'home' %}" class="btn-primary" aria-label="Back to home">Back home</a>
    <form class="lf-url-form" method="get" action="{% url '_product_management:dl' %}" aria-label="Customize leaflet sections">
      {% csrf_token %}
      <div class="lf-field-stack">
        <label for="site" class="visually-hidden">Website URL for QR code</label>
        <input id="site" name="site" type="url" placeholder="https://example.com" value="{{ current_site_raw }}">
      </div>
      <details class="lf-editor"{% if leaflet_overrides_active %} open{% endif %}>
        <summary>Edit leaflet copy</summary>
        <div class="lf-editor-grid">
          <div>
            <label for="company_name">Company name</label>
            <input id="company_name" name="company_name" type="text" value="{{ company_name }}">
          </div>
          <div>
            <label for="company_tagline">Company tagline</label>
            <input id="company_tagline" name="company_tagline" type="text" value="{{ company_tagline }}">
          </div>
          <div>
            <label for="headline">Headline</label>
            <input id="headline" name="headline" type="text" value="{{ headline }}">
          </div>
          <div>
            <label for="bullet_1">Bullet 1</label>
            <input id="bullet_1" name="bullet_1" type="text" value="{{ bullet_1 }}">
          </div>
          <div>
            <label for="bullet_2">Bullet 2</label>
            <input id="bullet_2" name="bullet_2" type="text" value="{{ bullet_2 }}">
          </div>
          <div>
            <label for="bullet_3">Bullet 3</label>
            <input id="bullet_3" name="bullet_3" type="text" value="{{ bullet_3 }}">
          </div>
          <div>
            <label for="cta_title">CTA title</label>
            <input id="cta_title" name="cta_title" type="text" value="{{ cta_title }}">
          </div>
          <div>
            <label for="cta_subtitle">CTA description</label>
            <textarea id="cta_subtitle" name="cta_subtitle" rows="2">{{ cta_subtitle }}</textarea>
          </div>
        </div>
      </details>
      <div class="lf-toolbar-actions">
        <button type="submit" class="btn-primary">Update preview</button>
        {% if can_save_leaflet %}
        <button type="submit" class="btn-secondary" formmethod="post" formaction="{% url '_product_management:dl_save_copy' %}">Save as default</button>
        {% endif %}
        <button type="button" id="leaflet-snapshot" class="btn-secondary" data-snapshot-url="{% url '_product_management:dl_snapshot' %}">Download snapshot</button>
      </div>
    </form>
    {% if normalized_site %}
      {% if site_query_string %}
        <a class="back-home" href="{% url '_product_management:dl_pdf' %}?{{ site_query_string }}" aria-label="Download PDF">Download PDF</a>
      {% else %}
        <a class="back-home" href="{% url '_product_management:dl_pdf' %}?site={{ normalized_site|urlencode }}" aria-label="Download PDF">Download PDF</a>
      {% endif %}
    {% else %}
      <span class="back-home disabled" aria-disabled="true">Download PDF</span>
    {% endif %}
  </div>
  {% endif %}

  <div class="leaflet">
    <main class="lf-body">
      <div class="lf-table">
        <!-- Top stack: auto height content -->
        <div class="row stack"><div class="stack-inner">
          
        <!-- 1) Company banner: logo + company name -->
        <section class="seg seg-banner">
            <div class="banner-logo"><img src="{% static 'images/Kingston_Online_Grocery_logo.png' %}" alt="Kingston Online Grocery logo"></div>
            <div class="banner-text">
              <p class="company-name">{{ company_name }}</p>
              <p class="company-tag">{{ company_tagline }}</p>
            </div>
          </section>

        
          <!-- Hero image section -->
        
          <section class="seg seg-hero">
          <img class="hero-img" src="{% static 'images/fresh_products.jpg' %}" alt="Fresh products">
        </section>

        <!-- 2) Marketing slogans / deals -->
        <section class="seg seg-slogans">
          <p class="headline">{{ headline }}</p>
          <ul class="bullets">
            <li>{{ bullet_1 }}</li>
            <li>{{ bullet_2 }}</li>
            <li>{{ bullet_3 }}</li>
          </ul>
        </section>

        <!-- 3) Call to action for QR scan -->
        <section class="seg seg-cta">
          <p class="cta-title">{{ cta_title }}</p>
          <p class="cta-sub">{{ cta_subtitle }}</p>
        </section>

        </div></div>

        <!-- Bottom row: expands to remaining height; QR anchored to bottom -->
        <div class="row qr-row"><div class="qr-row-cell">
          <section class="seg seg-qr">
              <div class="qr-wrap" aria-live="polite">
                {% if pdf and qr_data_uri %}
                  <img class="qr" src="{{ qr_data_uri }}" alt="QR code linking to {{ normalized_site|default:current_site_raw }}">
                {% elif current_site_raw %}
                  <img class="qr" src="{% url '_product_management:qr' %}?site={{ current_site_raw|urlencode }}{% if qr_kind %}&kind={{ qr_kind }}{% endif %}" alt="QR code linking to {{ normalized_site|default:current_site_raw }}" loading="lazy">
                {% else %}
                  <span class="muted">Add a website URL above to render QR</span>
                {% endif %}
              </div>
              {% if cta_subtitle %}
              <p class="qr-note">{{ cta_subtitle }}</p>
              {% endif %}
              {% if normalized_site %}
              <div class="qr-url muted">{{ normalized_site }}</div>
              {% elif current_site_raw %}
              <div class="qr-url muted">{{ current_site_raw }}</div>
              {% endif %}
            </section>
        </div></div>
      </div>
    </main>
  </div>
</body>
{% if not pdf %}
<script>
(function () {
  const button = document.getElementById('leaflet-snapshot');
  if (!button) {
    return;
  }
  const form = document.querySelector('.lf-url-form');
  const leafletEl = document.querySelector('.leaflet');
  if (!form || !leafletEl) {
    button.disabled = true;
    return;
  }
  const snapshotUrl = button.dataset.snapshotUrl;
  const csrfInput = form.querySelector('input[name="csrfmiddlewaretoken"]');
  let html2CanvasLoader;

  const resetLabel = () => {
    button.disabled = false;
    button.textContent = 'Download snapshot';
  };

  const ensureHtml2Canvas = () => {
    if (window.html2canvas) {
      return Promise.resolve(window.html2canvas);
    }
    if (!html2CanvasLoader) {
      html2CanvasLoader = new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        script.integrity = 'sha256-W3v1hb5cfBr9L8zIXzx3yNzOzVLNATiOZCzWEyPoXj0=';
        script.crossOrigin = 'anonymous';
        script.onload = () => resolve(window.html2canvas);
        script.onerror = () => reject(new Error('html2canvas failed to load'));
        document.head.appendChild(script);
      });
    }
    return html2CanvasLoader;
  };

  const triggerDownload = (blob) => {
    const stamp = new Date().toISOString().replace(/[:T]/g, '-').slice(0, 19);
    const url = URL.createObjectURL(blob);
    const anchor = document.createElement('a');
    anchor.href = url;
    anchor.download = `leaflet-${stamp}.png`;
    document.body.appendChild(anchor);
    anchor.click();
    document.body.removeChild(anchor);
    URL.revokeObjectURL(url);
  };

  const captureClientSide = async () => {
    const html2canvas = await ensureHtml2Canvas();
    if (!html2canvas) {
      throw new Error('html2canvas unavailable');
    }
    const canvas = await html2canvas(leafletEl, {
      backgroundColor: '#ffffff',
      scale: window.devicePixelRatio > 1 ? 2 : 1.5,
      useCORS: true,
    });
    const blob = await new Promise((resolve, reject) => {
      canvas.toBlob((result) => (result ? resolve(result) : reject(new Error('Unable to encode canvas'))), 'image/png');
    });
    triggerDownload(blob);
  };

  const requestServerSnapshot = async () => {
    const formData = new FormData(form);
    const response = await fetch(snapshotUrl, {
      method: 'POST',
      headers: {
        'X-CSRFToken': csrfInput ? csrfInput.value : '',
      },
      body: formData,
    });
    const contentType = response.headers.get('content-type') || '';
    if (response.ok && contentType.includes('image/')) {
      const blob = await response.blob();
      triggerDownload(blob);
      return;
    }

    let payload = null;
    if (contentType.includes('application/json')) {
      try {
        payload = await response.json();
      } catch (err) {
        payload = null;
      }
    }

    if (payload && payload.requires_client) {
      await captureClientSide();
      return;
    }

    const detail = payload && payload.detail ? payload.detail : await response.text();
    throw new Error(detail || `Snapshot request failed with status ${response.status}`);
  };

  button.addEventListener('click', async () => {
    if (button.disabled) {
      return;
    }
    button.disabled = true;
    button.textContent = 'Preparingâ€¦';
    try {
      await requestServerSnapshot();
    } catch (error) {
      console.error('Failed to capture leaflet preview', error);
      alert('Could not capture the leaflet preview. Please try again.');
    } finally {
      resetLabel();
    }
  });
})();
</script>
{% endif %}
</html>
