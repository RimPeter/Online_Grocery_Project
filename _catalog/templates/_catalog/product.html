{% extends 'base.html' %}
{% load static %}

{% block title %}
  Product List - Online Grocery
{% endblock %}

{% block content %}
<div class="container">
  <h1>Product List</h1>

  <div class="row">
    <!-- Left Column: Collapsible Category Menu -->
    <div class="col-md-3 mb-4">
      <div class="card">
        <div class="card-header">
          <strong>Categories</strong>
        </div>

        <ul class="list-group list-group-flush">
          {% for level1_category, level2_categories in level1_to_level2.items %}
          <li class="list-group-item">
            <!-- Collapsible trigger for Level 1 Category -->
            <!-- 
              Use a unique ID for each collapse target, e.g. "collapse-{{ forloop.counter }}" 
            -->
            <a
              class="d-flex justify-content-between align-items-center text-decoration-none"
              data-bs-toggle="collapse"
              href="#collapse-{{ forloop.counter }}"
              role="button"
              aria-expanded="false"
              aria-controls="collapse-{{ forloop.counter }}"
            >
              <strong>{{ level1_category }}</strong>
              <!-- A down arrow icon (Bootstrap Icons, Font Awesome, or an inline symbol) -->
              <span class="ms-2">
                <i class="bi bi-caret-down-fill"></i>
              </span>
            </a>

            <!-- Level 2 Category List (collapsible) -->
            <ul
              class="collapse ms-4 mt-2"
              id="collapse-{{ forloop.counter }}"
              style="list-style-type: disc;"
            >
              {% for level2_category in level2_categories %}
              <li style="list-style-position: outside;">
                <a class="text-decoration-none" href="?q={{ level2_category }}">
                  {{ level2_category }}
                </a>
              </li>
              {% endfor %}
            </ul>
          </li>
          {% endfor %}
        </ul>
      </div>
    </div>

    <!-- Right Column: Search Form & Product Listing -->
    <div class="col-md-9">
      <!-- Search Form -->
      <form method="GET" action="" class="mb-3">
        <div class="input-group">
          <input
            type="text"
            name="q"
            class="form-control"
            placeholder="Search for products..."
            value="{{ request.GET.q }}"
          />
          <button class="btn btn-outline-secondary" type="submit">
            Search
          </button>
        </div>
      </form>

      <!-- Product Grid -->
      <div class="row gy-4">
        {% for product in products %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-6 d-flex align-items-stretch">
          <div class="card mb-4 shadow-sm h-100">
            {% if product.image_url %}
            <img
              src="{{ product.image_url }}"
              class="card-img-top"
              alt="{{ product.name }}"
            />
            {% else %}
            <img
              src="{% static 'images/default_product.jpg' %}"
              class="card-img-top"
              alt="No Image"
            />
            {% endif %}
            <div class="card-body d-flex flex-column">
              <h6 class="card-title">{{ product.name }}</h6>
              <p class="card-text">
                {{ product.variant|default:"No description available" }}
              </p>
            
              <p class="card-text">
                <strong>Price:</strong> Â£{{ product.price }}
              </p>
              {% if product.promotion_end_date %}
              <p class="card-text text-danger">
                <strong>Promotion ends on:</strong> {{ product.promotion_end_date }}
              </p>
              {% endif %}

              <div class="mt-auto">
                <a
                  href="{% url 'product_detail' product.pk %}"
                  class="btn btn-primary mb-2"
                  >View Details</a
                >
                <!-- Add to Cart Form -->
                <form method="POST" action="{% url 'add_to_cart' product.id %}">
                  {% csrf_token %}
                  <button type="submit" class="btn btn-primary">
                    Add to Cart
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        {% empty %}
        <p>No products available.</p>
        {% endfor %}
      </div>

      <!-- Pagination Controls -->
      <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
          <li class="page-item">
            <a
              class="page-link"
              href="?q={{ query }}&page={{ page_obj.previous_page_number }}"
              aria-label="Previous"
            >
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
            </a>
          </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              {% if page_obj.number == num %}
                <li class="page-item active">
                  <a class="page-link" href="#">{{ num }}</a>
                </li>
              {% else %}
                <li class="page-item">
                  <a
                    class="page-link"
                    href="?q={{ query }}&page={{ num }}"
                  >{{ num }}</a>
                </li>
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
          <li class="page-item">
            <a
              class="page-link"
              href="?q={{ query }}&page={{ page_obj.next_page_number }}"
              aria-label="Next"
            >
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {% else %}
          <li class="page-item disabled">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
            </a>
          </li>
          {% endif %}
        </ul>
      </nav>
      <!-- End of Pagination -->
    </div> <!-- End Right Column -->

  </div> <!-- End .row -->
</div>
{% endblock %}
