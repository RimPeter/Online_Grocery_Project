{% extends 'base.html' %}
{% load static %}

{% block title %}
  Product List - Online Grocery
{% endblock %}

{% block content %}
<div class="container">
  <h1>Product List</h1>

  <div class="row">
    <!-- Left Column: Collapsible Category Menu -->
    <div class="col-md-3 mb-4">
      <div class="card">
        <div class="card-header">
          <strong>Categories</strong>
        </div>

        <ul class="list-group list-group-flush">
          {% for level1, node in category_tree.items %}
            <li class="list-group-item">
              {% if node.items %}
                <a
                  class="d-flex justify-content-between align-items-center text-decoration-none"
                  data-bs-toggle="collapse"
                  href="#cat-{{ forloop.counter }}"
                  role="button"
                  aria-expanded="false"
                  aria-controls="cat-{{ forloop.counter }}"
                >
                  <strong>{{ level1 }}</strong>
                  <span class="ms-2"><i class="bi bi-caret-down-fill"></i></span>
                </a>

                <ul class="collapse ms-4 mt-2" id="cat-{{ forloop.counter }}" style="list-style-type: disc;">
                  {% for level2, _ in node.items %}
                    <li style="list-style-position: outside;">
                      <a class="text-decoration-none {% if request.GET.l1 == level1 and request.GET.l2 == level2 %}fw-bold{% endif %}"
                         href="?l1={{ level1|urlencode }}&l2={{ level2|urlencode }}"
                         {% if request.GET.l1 == level1 and request.GET.l2 == level2 %}aria-current="page"{% endif %}>
                        {{ level2 }}
                      </a>
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <a class="text-decoration-none d-block {% if request.GET.l1 == level1 and not request.GET.l2 %}fw-bold{% endif %}"
                   href="?l1={{ level1|urlencode }}"
                   {% if request.GET.l1 == level1 and not request.GET.l2 %}aria-current="page"{% endif %}>
                  <strong>{{ level1 }}</strong>
                </a>
              {% endif %}
            </li>
          {% empty %}
            <li class="list-group-item text-muted">No categories found.</li>
          {% endfor %}
        </ul>

      </div>
    </div>

    <!-- Right Column: Search Form & Product Listing -->
    <div class="col-md-9">

      {# Quick reorder from last 3 orders #}
      {% if user.is_authenticated and recent_purchased_items %}
      <div class="card mb-3">
        <div class="card-body">
          <form id="recent-reorder-form" method="POST">
            {% csrf_token %}
            <input type="hidden" name="return_to" value="{{ request.get_full_path }}" />
            <input type="hidden" id="recent-reorder-id" />
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0">Reorder from last 3 orders</label>
              <button type="button" id="recent-add-all" class="btn btn-sm btn-success">Add All To Cart</button>
            </div>
            <div class="input-group align-items-center">
              <span class="input-group-text p-1" style="background:white;border:none;">
                <img id="recent-reorder-img" src="{% static 'images/fresh_products.jpg' %}" alt="preview" style="width:40px;height:40px;object-fit:contain;" onerror="this.onerror=null;this.src='{% static 'images/fresh_products.jpg' %}';" />
              </span>
              <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="recent-reorder-button" data-bs-toggle="dropdown" aria-expanded="false">
                  Select item
                </button>
                <ul class="dropdown-menu" aria-labelledby="recent-reorder-button" id="recent-reorder-menu" style="max-height: 260px; overflow-y: auto;">
                  {% for it in recent_purchased_items %}
                  <li class="px-1">
                    <div class="d-flex align-items-center justify-content-between gap-2">
                      <a class="dropdown-item d-inline-flex align-items-center w-auto flex-grow-1" href="#" data-role="select" data-id="{{ it.product_id }}" data-img="{{ it.image_url }}" data-qty="{{ it.quantity }}">
                        {% if it.image_url and it.image_url != '/img/products/no-image.png' %}
                          <img src="{{ it.image_url }}" alt="{{ it.name }}" class="me-2" style="width:28px;height:28px;object-fit:contain;" onerror="this.onerror=null;this.src='{% static 'images/fresh_products.jpg' %}';" />
                        {% else %}
                          <img src="{% static 'images/fresh_products.jpg' %}" alt="{{ it.name }}" class="me-2" style="width:28px;height:28px;object-fit:contain;" />
                        {% endif %}
                        <span>{{ it.name }} (last qty {{ it.quantity }})</span>
                      </a>
                      <a class="btn btn-sm btn-outline-primary d-inline-flex align-items-center gap-1" href="{% url 'product_detail' it.product_id %}" title="View product details">
                        <i class="bi bi-eye"></i>
                        <span>Details</span>
                      </a>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
              </div>
              <input type="number" id="recent-reorder-qty" class="form-control" min="1" value="1" aria-label="Quantity" />
              <button class="btn btn-primary" type="submit">Add</button>
            </div>
          </form>
        </div>
      </div>
      {% endif %}

<form method="GET" action="" class="mb-3" id="search-form">
  {# preserve current filters when searching #}
  {% if request.GET.l1 %}<input type="hidden" name="l1" id="l1-field" value="{{ request.GET.l1 }}">{% else %}<input type="hidden" name="l1" id="l1-field">{% endif %}
  {% if request.GET.l2 %}<input type="hidden" name="l2" id="l2-field" value="{{ request.GET.l2 }}">{% else %}<input type="hidden" name="l2" id="l2-field">{% endif %}

  <div class="input-group">
    <input
      type="text"
      name="q"
      id="search-input"
      class="form-control"
      placeholder="Search for products or categories..."
      value="{{ request.GET.q }}"
      list="category-suggestions"
      autocomplete="off"
      aria-label="Search products"
    />
  </div>

  {# As-you-type dropdown suggestions: Level-1, Level-2, and combined "L1 - L2" #}
  <datalist id="category-suggestions">
    {% for level1, node in category_tree.items %}
      <option value="{{ level1 }}"></option>
      {% if node.items %}
        {% for level2, _ in node.items %}
          <option value="{{ level2 }}"></option>
          <option value="{{ level1 }} - {{ level2 }}"></option>
        {% endfor %}
      {% endif %}
    {% endfor %}
  </datalist>
</form>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('search-form');
    const input = document.getElementById('search-input');
    const datalist = document.getElementById('category-suggestions');

    if (!form || !input || !datalist) return;

    const allowed = new Set(Array.from(datalist.options).map(o => o.value));

    // Submit when a datalist option is selected
    input.addEventListener('change', function () {
      const val = input.value.trim();
      if (allowed.has(val)) {
        form.submit();
      }
    });

    // Prevent Enter submit unless value matches a suggestion
    input.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        const val = input.value.trim();
        if (!allowed.has(val)) {
          e.preventDefault();
        }
      }
    });
  });
  </script>

{# Safe JSON payloads for exact-matching on submit #}
{{ level1_names|json_script:"level1-names" }}
{{ level2_names|json_script:"level2-names" }}

      

      <!-- Product Container -->
      <div class="row gy-4" id="product-container">
        {% for product in products %}
          {% include '_catalog/product_item.html' with product=product %}
        {% empty %}
          <div class="col-12">
            <p class="text-muted">No products matched your filters.
              <a href="{% url 'product_list' %}">Clear filters</a>
            </p>
          </div>
        {% endfor %}
      </div>

      <!-- Pagination (replaces infinite scroll) -->
      {% if page_obj %}
      <nav aria-label="Product pagination" class="mt-3">
        <ul class="pagination justify-content-center">
          <li class="page-item {% if not page_obj.has_previous %}disabled{% endif %}">
            {% if page_obj.has_previous %}
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&amp;q={{ request.GET.q|urlencode }}{% endif %}{% if request.GET.l1 %}&amp;l1={{ request.GET.l1|urlencode }}{% endif %}{% if request.GET.l2 %}&amp;l2={{ request.GET.l2|urlencode }}{% endif %}" aria-label="Previous">Previous</a>
            {% else %}
              <span class="page-link" aria-disabled="true">Previous</span>
            {% endif %}
          </li>
          <li class="page-item disabled">
            <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
          </li>
          <li class="page-item {% if not page_obj.has_next %}disabled{% endif %}">
            {% if page_obj.has_next %}
              <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&amp;q={{ request.GET.q|urlencode }}{% endif %}{% if request.GET.l1 %}&amp;l1={{ request.GET.l1|urlencode }}{% endif %}{% if request.GET.l2 %}&amp;l2={{ request.GET.l2|urlencode }}{% endif %}" aria-label="Next">Next</a>
            {% else %}
              <span class="page-link" aria-disabled="true">Next</span>
            {% endif %}
          </li>
        </ul>
      </nav>
      {% endif %}

    </div> <!-- End Right Column -->
  </div> <!-- End .row -->
</div>

<!-- Infinite scroll removed; using standard pagination above -->

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('recent-reorder-form');
    if (!form) return;
    const idInput = document.getElementById('recent-reorder-id');
    const qty = document.getElementById('recent-reorder-qty');
    const img = document.getElementById('recent-reorder-img');
    const btn = document.getElementById('recent-reorder-button');
    const menu = document.getElementById('recent-reorder-menu');
    const addAllBtn = document.getElementById('recent-add-all');
    const addUrlTemplate = "{% url 'add_to_cart' 999999 %}".replace('999999', '__ID__');

    const selectItem = (pid, label, imageUrl) => {
      if (idInput) idInput.value = pid;
      if (btn) btn.textContent = label || 'Selected item';
      if (img) {
        if (imageUrl && imageUrl !== '/img/products/no-image.png') {
          img.src = imageUrl;
        } else {
          img.src = "{% static 'images/fresh_products.jpg' %}";
        }
      }
    };

    menu && menu.addEventListener('click', function (e) {
      const a = e.target.closest('a[data-role="select"]');
      if (!a) return;
      e.preventDefault();
      const pid = a.getAttribute('data-id');
      const imageUrl = a.getAttribute('data-img') || '';
      const label = (a.querySelector('span') && a.querySelector('span').textContent) || a.textContent || '';
      selectItem(pid, label.trim(), imageUrl);
    });

    // Preselect first item if available
    const first = menu && menu.querySelector('a[data-role="select"]');
    if (first) {
      const pid = first.getAttribute('data-id');
      const imageUrl = first.getAttribute('data-img') || '';
      const label = (first.querySelector('span') && first.querySelector('span').textContent) || first.textContent || '';
      selectItem(pid, label.trim(), imageUrl);
    }

    form.addEventListener('submit', function (e) {
      const pid = idInput && idInput.value;
      if (!pid) {
        e.preventDefault();
        return;
      }
      // Update action to the product-specific add_to_cart URL
      form.action = addUrlTemplate.replace('__ID__', pid);

      // Ensure quantity field exists for POST
      let qInput = form.querySelector('input[name="quantity"]');
      if (!qInput) {
        qInput = document.createElement('input');
        qInput.type = 'hidden';
        qInput.name = 'quantity';
        form.appendChild(qInput);
      }
      const q = parseInt((qty && qty.value) || '1', 10);
      qInput.value = isNaN(q) || q < 1 ? 1 : q;
    });

    // Add all items to cart using fetch
    addAllBtn && addAllBtn.addEventListener('click', async function () {
      const anchors = menu ? Array.from(menu.querySelectorAll('a[data-role="select"]')) : [];
      if (!anchors.length) return;
      const csrf = form.querySelector('input[name="csrfmiddlewaretoken"]').value;
      const returnTo = form.querySelector('input[name="return_to"]').value;
      addAllBtn.disabled = true;
      addAllBtn.textContent = 'Adding...';
      try {
        for (const a of anchors) {
          const pid = a.getAttribute('data-id');
          const q = parseInt(a.getAttribute('data-qty') || '1', 10) || 1;
          const url = addUrlTemplate.replace('__ID__', pid);
          await fetch(url, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrf,
              'X-Requested-With': 'XMLHttpRequest',
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({ quantity: q, return_to: returnTo })
          });
        }
        // After all requests complete, reload or redirect to reflect cart updates
        window.location.href = returnTo || window.location.href;
      } catch (e) {
        console.error('Failed to add all items', e);
        addAllBtn.disabled = false;
        addAllBtn.textContent = 'Add All To Cart';
      }
    });

    // Preview handled in selectItem and initial preselect; nothing else to do
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('search-form');
    var input = document.getElementById('search-input');
    var l1 = document.getElementById('l1-field');
    var l2 = document.getElementById('l2-field');
    if (form && input && l1 && l2) {
      form.addEventListener('submit', function () {
        var v = (input.value || '').trim();
        var sep = ' - ';
        if (v.indexOf(sep) !== -1) {
          var parts = v.split(sep);
          l1.value = (parts[0] || '').trim();
          l2.value = (parts[1] || '').trim();
          input.value = '';
        }
      });
    }
  });
}</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Existing intersection observer code for infinite scroll ...
    
    // Show any Bootstrap toasts if there are messages
    var toastElList = [].slice.call(document.querySelectorAll('.toast'));
    var toastList = toastElList.map(function (toastEl) {
      return new bootstrap.Toast(toastEl);
    });
    toastList.forEach(toast => toast.show());
  });
</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
  const form   = document.getElementById('search-form');
  const input  = document.getElementById('search-input');
  const l1f    = document.getElementById('l1-field');
  const l2f    = document.getElementById('l2-field');
  const L1     = JSON.parse(document.getElementById('level1-names').textContent || "[]");
  const L2     = JSON.parse(document.getElementById('level2-names').textContent || "[]");

  const fold = s => (s || '').toLocaleLowerCase();

  form.addEventListener('submit', function () {
    const v = input.value.trim();
    if (!v) return; // nothing to do

    // Combined "Level1 › Level2"
    if (v.includes('›')) {
      const [l1, l2] = v.split('›').map(s => s.trim());
      if (L1 - L2f.value = '';
    // Otherwise: leave as free-text fuzzy search
  });
});
</script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Only on small screens
    const isMobile = window.matchMedia('(max-width: 768px)').matches;
    if (!isMobile) return;

    if (sessionStorage.getItem('restoredScrollOnce') === '1') return;

    // Only after a search or category filter
    const params = new URLSearchParams(window.location.search);
    const didFilter = params.has('q') || params.has('l1') || params.has('l2');
    if (!didFilter) return;

    // Scroll to the first product card
    requestAnimationFrame(() => {
      // Grab the first rendered child within the product grid
      const firstItem = document.querySelector('#product-container > *');
      if (!firstItem) return;

      // If you have a fixed/sticky navbar, offset for it
      const header = document.querySelector('.sticky-top, .navbar, header');
      const offset = header ? header.getBoundingClientRect().height : 0;

      const y = firstItem.getBoundingClientRect().top + window.pageYOffset - offset - 8;
      window.scrollTo({ top: y, behavior: 'smooth' });
    });
  });
</script>
<script>
/**
 * Preserve scroll position across the add-to-cart redirect (esp. mobile).
 * - On submit of an .add-to-cart-form, store scrollY.
 * - On next load, restore it immediately.
 */
(function () {
  // Try to prevent browsers from auto-resetting scroll
  if ('scrollRestoration' in history) {
    history.scrollRestoration = 'manual';
  }

  // Restore scroll as early as possible on the new page
  if (sessionStorage.getItem('restoreAfterAdd') === '1') {
    var y = parseInt(sessionStorage.getItem('scrollYBeforeAdd') || '0', 10);
    if (!isNaN(y)) {
      window.scrollTo(0, y);
    }
    // Let other scripts know we've restored; clear shortly after
    sessionStorage.setItem('restoredScrollOnce', '1');
    setTimeout(function () {
      sessionStorage.removeItem('restoredScrollOnce');
    }, 1000);

    sessionStorage.removeItem('restoreAfterAdd');
    sessionStorage.removeItem('scrollYBeforeAdd');
  }

  // Capture submits on any current/future add-to-cart form (works with infinite scroll)
  document.addEventListener('submit', function (e) {
    var f = e.target;
    if (f && f.classList && f.classList.contains('add-to-cart-form')) {
      sessionStorage.setItem('scrollYBeforeAdd', String(window.scrollY));
      sessionStorage.setItem('restoreAfterAdd', '1');
    }
  }, true); // capture phase catches it even if forms are inside other handlers
})();
</script>
<script>
document.addEventListener('submit', function (e) {
  const f = e.target.closest('form.add-to-cart-form');
  if (!f) return;
  const good = f.dataset.actionUrl;
  if (good && f.getAttribute('action') !== good) {
    f.setAttribute('action', good);
  }
}, true);
</script>




{% endblock %}


